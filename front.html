<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlyingGOAT</title>
    <style>
        /* Стили остаются без изменений */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, hsl(120, 16%, 92%), #eefff0);
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }

        h1 {
            font-size: 3rem;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 20px;
            background: linear-gradient(45deg, #566354, #1f3e28);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: glow 2s infinite alternate;
        }

        @keyframes glow {
            from {
                text-shadow: 0 0 10px #c9d8ca, 0 0 20px #9fcb9c;
            }

            to {
                text-shadow: 0 0 20px #2c6d3d, 0 0 30px #004e16;
            }
        }

        /* Контейнер кнопок */
        .button-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            margin: 20px 0;
        }

        /* Стиль кнопок */
        button {
            background: linear-gradient(135deg, #3f8a3f, #3e8e41);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1rem;
            font-weight: bold;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        button:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
        }

        button.emergency {
            background: linear-gradient(135deg, #c1271c, #ba000d);
            /* Красный градиент */
        }

        button:active {
            transform: scale(0.95);
        }

        /* Контейнер для терминалов */
        .terminal-container {
            display: flex;
            gap: 20px;
            width: 90%;
            max-width: 1600px;
            /* Максимальная ширина для двух терминалов */
            margin-top: 20px;
        }

        /* Общие стили для терминалов */
        .terminal,
        .image-terminal {
            flex: 1;
            /* Равномерное распределение ширины */
            background: rgba(0, 0, 0, 0.7);
            color: #00ff00;
            height: 300px;
            overflow-y: auto;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            font-family: 'Courier New', Courier, monospace;
            font-size: 1rem;
            line-height: 1.5;
        }

        .terminal::-webkit-scrollbar,
        .image-terminal::-webkit-scrollbar {
            width: 8px;
        }

        .terminal::-webkit-scrollbar-thumb,
        .image-terminal::-webkit-scrollbar-thumb {
            background: #00ff00;
            border-radius: 5px;
        }

        .terminal::-webkit-scrollbar-track,
        .image-terminal::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
        }

        /* Стиль для изображений */
        .image-terminal img {
            max-width: 100%;
            height: auto;
            margin-bottom: 10px;
            border: 2px solid #00ff00;
            border-radius: 5px;
        }

        /* Статус дронов */
        .drone-status {
            margin-top: 20px;
            width: 90%;
            max-width: 800px;
            background: rgba(0, 0, 0, 0.7);
            color: #00ff00;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            font-family: 'Courier New', Courier, monospace;
            font-size: 1rem;
            line-height: 1.5;
        }

        .drone-status div {
            margin-bottom: 10px;
        }
    </style>
</head>

<body>
    <!-- Заголовок -->
    <h1>FlyingGOAT</h1>

    <!-- Контейнер с кнопками -->
    <div class="button-container">
        <button id="startMission">Запуск полетного задания</button>
        <button id="emergencyShutdown" class="emergency">Экстренное выключение</button>
        <!-- Добавлен класс emergency -->
        <button id="land">Посадка</button>
        <button id="pause">Пауза</button>
    </div>

    <!-- Контейнер для терминалов -->
    <div class="terminal-container">
        <!-- Терминал статуса -->
        <div class="terminal" id="statusTerminal">
            <!-- Здесь будет выводиться текст -->
        </div>

        <!-- Терминал для изображений -->
        <div class="image-terminal" id="imageTerminal">
            <!-- Здесь будут выводиться изображения и информация -->
        </div>
    </div>

    <!-- Статус дронов -->
    <div class="drone-status" id="droneStatus">
        <!-- Здесь будут отображаться статусы дронов -->
    </div>

    <script>
        // Функция для отправки данных на сервер
        async function sendToBackend(action) {
            try {
                const response = await fetch('http://127.0.0.1:8000/api/action', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                appendToTerminal(data.message);
            } catch (error) {
                console.error('Error sending data to backend:', error);
                appendToTerminal('[ERROR] Не удалось связаться с сервером');
            }
        }

        // Функция для добавления текста в текстовый терминал
        function appendToTerminal(message) {
            const terminal = document.getElementById('statusTerminal');
            terminal.innerHTML += message + '<br>';
            terminal.scrollTop = terminal.scrollHeight; // Автопрокрутка вниз
        }

        // Функция для добавления изображений и информации в терминал изображений
        function appendToImageTerminal(imageData, coordinates, area) {
            const imageTerminal = document.getElementById('imageTerminal');

            // Создаем контейнер для изображения и информации
            const container = document.createElement('div');
            container.innerHTML = `
                <img src="data:image/png;base64,${imageData}" alt="Изображение возгорания">
                <p>Координаты: ${coordinates}</p>
                <p>Площадь возгорания: ${area} см²</p>
            `;
            imageTerminal.appendChild(container);

            // Прокручиваем терминал вниз
            imageTerminal.scrollTop = imageTerminal.scrollHeight;
        }

        // Обработчики событий для кнопок
        document.getElementById('startMission').addEventListener('click', () => {
            sendToBackend('start_mission');
        });

        document.getElementById('emergencyShutdown').addEventListener('click', () => {
            sendToBackend('emergency_shutdown');
        });

        document.getElementById('land').addEventListener('click', () => {
            sendToBackend('land');
        });

        // Добавление обработчика для кнопки "Пауза"
        let isPaused = false; // Флаг для отслеживания состояния паузы
        document.getElementById('pause').addEventListener('click', () => {
            if (isPaused) {
                // Если пауза активна, возобновляем выполнение
                sendToBackend('pause');
                document.getElementById('pause').textContent = 'Пауза';
                isPaused = false;
            } else {
                // Если пауза не активна, ставим на паузу
                sendToBackend('pause');
                document.getElementById('pause').textContent = 'Возобновить';
                isPaused = true;
            }
        });

        // Глобальные переменные для хранения элементов статуса дронов
        const droneElements = {};

        // Функция для инициализации статусов дронов
        function initializeDroneStatus() {
            const droneStatusContainer = document.getElementById('droneStatus');
            for (let droneId = 0; droneId < 2; droneId++) {
                const statusDiv = document.createElement('div');
                statusDiv.id = `drone-${droneId}`;
                statusDiv.innerHTML = `
                    Дрон ${droneId}: 
                    Соединение - <span id="connection-${droneId}">✘</span>, 
                    Готовность - <span id="readiness-${droneId}">✘</span>, 
                    Батарея - <span id="battery-percent-${droneId}">0%</span>, 
                    Напряжение - <span id="battery-voltage-${droneId}">0 В</span>`;
                droneStatusContainer.appendChild(statusDiv);

                // Сохраняем ссылки на элементы
                droneElements[droneId] = {
                    connection: document.getElementById(`connection-${droneId}`),
                    readiness: document.getElementById(`readiness-${droneId}`),
                    batteryPercent: document.getElementById(`battery-percent-${droneId}`),
                    batteryVoltage: document.getElementById(`battery-voltage-${droneId}`)
                };
            }
        }

        // Функция для обновления статуса дронов
        async function fetchDroneStatus() {
            try {
                // Создаем массив промисов для запросов к двум дронам
                const droneRequests = [0, 1].map(droneId =>
                    fetch(`http://127.0.0.1:8000/api/status/${droneId}`).then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                );

                // Выполняем все запросы параллельно
                const statuses = await Promise.all(droneRequests);

                // Обновляем статусы дронов
                statuses.forEach((status, droneId) => {
                    const droneElement = droneElements[droneId];
                    droneElement.connection.textContent = status.connection ? '✔' : '✘';
                    droneElement.readiness.textContent = status.readiness ? '✔' : '✘';
                    droneElement.batteryPercent.textContent = `${status.battery_percent}%`;
                    droneElement.batteryVoltage.textContent = `${status.battery_voltage} В`;
                });
            } catch (error) {
                console.error('Error fetching drone statuses:', error);

                // If an error occurs, set default statuses for all drones
                for (let droneId = 0; droneId < 2; droneId++) {
                    const droneElement = droneElements[droneId];
                    droneElement.connection.textContent = '✘';
                    droneElement.readiness.textContent = '✘';
                    droneElement.batteryPercent.textContent = '0%';
                    droneElement.batteryVoltage.textContent = '0 В';
                }
            }
        }

        // Initialize drone statuses
        initializeDroneStatus();

        // Update statuses every 15 seconds
        setInterval(fetchDroneStatus, 15000);

        // Initial load of statuses
        fetchDroneStatus();

        // Функция для получения данных о пожарах
        const fireDataWS = new WebSocket("ws://127.0.0.1:8000/api/fire-data");

        fireDataWS.onopen = () => {
            console.log("Connected to fire data WebSocket");
        };

        fireDataWS.onmessage = (event) => {
            try {
                // Parse the received JSON data (an array of fire data objects)
                const fireDataArray = JSON.parse(event.data);
                const imageTerminal = document.getElementById('imageTerminal');
                
                // Optionally clear existing images (if you want to replace old frames)
                imageTerminal.innerHTML = '';

                // Append each fire data object to the image terminal
                fireDataArray.forEach(({ image_data, coordinates, area }) => {
                    appendToImageTerminal(image_data, coordinates, area);
                });
            } catch (error) {
                console.error("Error parsing fire data:", error);
            }
        };

        fireDataWS.onerror = (error) => {
            console.error("WebSocket error:", error);
        };

        fireDataWS.onclose = (event) => {
            console.log("Fire data WebSocket closed:", event);
        };
    </script>
</body>

</html>